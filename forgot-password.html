<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passwort zurücksetzen - KI Konzept Builder</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Setze dein Passwort für den KI Konzept Builder zurück">
    
    <!-- Styles -->
    <link rel="stylesheet" href="notion-design-system.css">
    <link rel="stylesheet" href="loading-states.css">
    
    <style>
        body {
            background: linear-gradient(to bottom, #f6f5f4 0%, #fff 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .reset-container {
            max-width: 480px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        
        .reset-card {
            background: white;
            border-radius: 16px;
            padding: 48px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }
        
        .logo-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 600;
            color: #097fe8;
            text-decoration: none;
            margin-bottom: 8px;
        }
        
        .logo svg {
            width: 32px;
            height: 32px;
        }
        
        .title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1f2937;
            text-align: center;
        }
        
        .subtitle {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 32px;
            text-align: center;
            line-height: 1.5;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #097fe8;
            box-shadow: 0 0 0 3px rgba(9, 127, 232, 0.1);
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .info-message {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .button-primary {
            width: 100%;
            background: #097fe8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .button-primary:hover {
            background: #0075de;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(9, 127, 232, 0.3);
        }
        
        .button-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .back-link {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .back-link a {
            color: #097fe8;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link a:hover {
            text-decoration: underline;
        }
        
        .reset-code-section {
            display: none;
        }
        
        .code-inputs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .code-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .code-input:focus {
            outline: none;
            border-color: #097fe8;
            box-shadow: 0 0 0 3px rgba(9, 127, 232, 0.1);
        }
        
        /* Dark mode support */
        [data-theme="dark"] {
            background: #1f2937;
        }
        
        [data-theme="dark"] .reset-card {
            background: #111827;
            color: #f9fafb;
        }
        
        [data-theme="dark"] .title {
            color: #f9fafb;
        }
        
        [data-theme="dark"] .subtitle {
            color: #9ca3af;
        }
        
        [data-theme="dark"] .form-label {
            color: #d1d5db;
        }
        
        [data-theme="dark"] .form-input,
        [data-theme="dark"] .code-input {
            background: #1f2937;
            border-color: #374151;
            color: #f9fafb;
        }
        
        [data-theme="dark"] .form-input:focus,
        [data-theme="dark"] .code-input:focus {
            border-color: #097fe8;
        }
    </style>
</head>
<body>
    <div class="reset-container">
        <div class="reset-card">
            <div class="logo-section">
                <a href="landing-page.html" class="logo">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                    </svg>
                    KI Konzept Builder
                </a>
            </div>
            
            <!-- Step 1: Email Input -->
            <div id="emailSection">
                <h1 class="title" data-i18n="auth.reset.title">Passwort zurücksetzen</h1>
                <p class="subtitle" data-i18n="auth.reset.subtitle">Gib deine E-Mail-Adresse ein und wir senden dir einen Code zum Zurücksetzen deines Passworts.</p>
                
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
                <div class="info-message" id="infoMessage"></div>
                
                <form id="resetForm" onsubmit="handleResetRequest(event)">
                    <div class="form-group">
                        <label class="form-label" for="email" data-i18n="auth.form.email_label">E-Mail Adresse</label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            class="form-input" 
                            data-i18n-placeholder="auth.form.email_placeholder"
                            required
                        >
                    </div>
                    
                    <button type="submit" class="button-primary" id="submitButton">
                        <span data-i18n="auth.reset.send_code">Code senden</span>
                    </button>
                </form>
            </div>
            
            <!-- Step 2: Code Verification -->
            <div id="codeSection" class="reset-code-section">
                <h1 class="title" data-i18n="auth.reset.verify_title">Code eingeben</h1>
                <p class="subtitle" data-i18n="auth.reset.verify_subtitle">Wir haben einen 6-stelligen Code an deine E-Mail gesendet.</p>
                
                <div class="error-message" id="codeErrorMessage"></div>
                
                <form id="codeForm" onsubmit="handleCodeVerification(event)">
                    <div class="code-inputs">
                        <input type="text" class="code-input" maxlength="1" oninput="handleCodeInput(this, 0)">
                        <input type="text" class="code-input" maxlength="1" oninput="handleCodeInput(this, 1)">
                        <input type="text" class="code-input" maxlength="1" oninput="handleCodeInput(this, 2)">
                        <input type="text" class="code-input" maxlength="1" oninput="handleCodeInput(this, 3)">
                        <input type="text" class="code-input" maxlength="1" oninput="handleCodeInput(this, 4)">
                        <input type="text" class="code-input" maxlength="1" oninput="handleCodeInput(this, 5)">
                    </div>
                    
                    <button type="submit" class="button-primary" id="verifyButton">
                        <span data-i18n="auth.reset.verify_code">Code überprüfen</span>
                    </button>
                </form>
                
                <div class="back-link">
                    <a href="#" onclick="showEmailSection()" data-i18n="auth.reset.resend_code">Neuen Code senden</a>
                </div>
            </div>
            
            <!-- Step 3: New Password -->
            <div id="passwordSection" class="reset-code-section">
                <h1 class="title" data-i18n="auth.reset.new_password_title">Neues Passwort festlegen</h1>
                <p class="subtitle" data-i18n="auth.reset.new_password_subtitle">Wähle ein sicheres Passwort für dein Konto.</p>
                
                <div class="error-message" id="passwordErrorMessage"></div>
                
                <form id="passwordForm" onsubmit="handlePasswordReset(event)">
                    <div class="form-group">
                        <label class="form-label" for="newPassword" data-i18n="auth.reset.new_password_label">Neues Passwort</label>
                        <input 
                            type="password" 
                            id="newPassword" 
                            name="newPassword" 
                            class="form-input" 
                            required
                            minlength="8"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="confirmPassword" data-i18n="auth.reset.confirm_password_label">Passwort bestätigen</label>
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            name="confirmPassword" 
                            class="form-input" 
                            required
                        >
                    </div>
                    
                    <button type="submit" class="button-primary" id="resetButton">
                        <span data-i18n="auth.reset.reset_password">Passwort zurücksetzen</span>
                    </button>
                </form>
            </div>
            
            <div class="back-link">
                <span data-i18n="auth.reset.back_to">Zurück zur</span> <a href="login.html" data-i18n="auth.reset.login_link">Anmeldung</a>
            </div>
        </div>
    </div>
    
    <script src="js/database-service.js"></script>
    <script src="i18n/i18n-complete.js"></script>
    <script src="js/email-service.js"></script>
    <script>
        let resetEmail = '';
        let resetCode = '';
        
        function handleResetRequest(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value.trim().toLowerCase();
            
            // Check if user exists
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[email];
            
            if (!user) {
                showError('errorMessage', 'Es wurde kein Konto mit dieser E-Mail-Adresse gefunden.');
                return;
            }
            
            // Check if user has OAuth account
            if (user.provider) {
                showError('errorMessage', `Dieses Konto wurde mit ${user.provider} erstellt. Bitte melde dich mit ${user.provider} an.`);
                return;
            }
            
            // Generate reset code
            resetCode = Math.floor(100000 + Math.random() * 900000).toString();
            resetEmail = email;
            
            // Store reset request
            const resetRequests = JSON.parse(localStorage.getItem('resetRequests') || '{}');
            resetRequests[email] = {
                code: resetCode,
                timestamp: Date.now(),
                used: false
            };
            localStorage.setItem('resetRequests', JSON.stringify(resetRequests));
            
            // Send email (in demo mode, show the code)
            if (window.emailService) {
                window.emailService.sendPasswordResetEmail(email, resetCode);
            }
            
            // Show info message with code (DEMO MODE)
            showInfo('infoMessage', `Demo-Modus: Dein Reset-Code ist: ${resetCode}`);
            
            // Show success and switch to code section
            showSuccess('successMessage', 'Ein Code wurde an deine E-Mail-Adresse gesendet.');
            
            setTimeout(() => {
                showCodeSection();
            }, 2000);
        }
        
        function handleCodeInput(input, index) {
            const value = input.value;
            
            if (value && index < 5) {
                // Move to next input
                const inputs = document.querySelectorAll('.code-input');
                inputs[index + 1].focus();
            }
            
            // Handle paste
            if (value.length > 1) {
                const code = value.substring(0, 6);
                const inputs = document.querySelectorAll('.code-input');
                
                for (let i = 0; i < code.length && i < 6; i++) {
                    inputs[i].value = code[i];
                }
                
                inputs[Math.min(code.length - 1, 5)].focus();
            }
        }
        
        function handleCodeVerification(event) {
            event.preventDefault();
            
            // Get code from inputs
            const inputs = document.querySelectorAll('.code-input');
            const enteredCode = Array.from(inputs).map(input => input.value).join('');
            
            if (enteredCode.length !== 6) {
                showError('codeErrorMessage', 'Bitte gib einen 6-stelligen Code ein.');
                return;
            }
            
            // Verify code
            const resetRequests = JSON.parse(localStorage.getItem('resetRequests') || '{}');
            const request = resetRequests[resetEmail];
            
            if (!request || request.code !== enteredCode) {
                showError('codeErrorMessage', 'Ungültiger Code. Bitte versuche es erneut.');
                return;
            }
            
            // Check if code is expired (30 minutes)
            if (Date.now() - request.timestamp > 30 * 60 * 1000) {
                showError('codeErrorMessage', 'Der Code ist abgelaufen. Bitte fordere einen neuen Code an.');
                return;
            }
            
            // Code is valid - show password reset form
            showPasswordSection();
        }
        
        function handlePasswordReset(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showError('passwordErrorMessage', 'Die Passwörter stimmen nicht überein.');
                return;
            }
            
            if (newPassword.length < 8) {
                showError('passwordErrorMessage', 'Das Passwort muss mindestens 8 Zeichen lang sein.');
                return;
            }
            
            // Update password
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[resetEmail];
            
            if (user) {
                user.password = btoa(newPassword); // Simple encoding for demo
                user.passwordResetAt = new Date().toISOString();
                users[resetEmail] = user;
                localStorage.setItem('users', JSON.stringify(users));
                
                // Mark reset code as used
                const resetRequests = JSON.parse(localStorage.getItem('resetRequests') || '{}');
                if (resetRequests[resetEmail]) {
                    resetRequests[resetEmail].used = true;
                    localStorage.setItem('resetRequests', JSON.stringify(resetRequests));
                }
                
                // Update in database if available
                if (window.db) {
                    window.db.update('users', user.id || resetEmail, {
                        passwordResetAt: user.passwordResetAt
                    });
                }
                
                // Show success
                showSuccess('passwordErrorMessage', 'Dein Passwort wurde erfolgreich zurückgesetzt. Du wirst zur Anmeldung weitergeleitet...');
                
                setTimeout(() => {
                    window.location.href = 'login.html?reset=true';
                }, 2000);
            }
        }
        
        function showEmailSection() {
            document.getElementById('emailSection').style.display = 'block';
            document.getElementById('codeSection').style.display = 'none';
            document.getElementById('passwordSection').style.display = 'none';
            clearMessages();
        }
        
        function showCodeSection() {
            document.getElementById('emailSection').style.display = 'none';
            document.getElementById('codeSection').style.display = 'block';
            document.getElementById('passwordSection').style.display = 'none';
            clearMessages();
            
            // Focus first code input
            document.querySelector('.code-input').focus();
        }
        
        function showPasswordSection() {
            document.getElementById('emailSection').style.display = 'none';
            document.getElementById('codeSection').style.display = 'none';
            document.getElementById('passwordSection').style.display = 'block';
            clearMessages();
        }
        
        function showError(elementId, message) {
            clearMessages();
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function showSuccess(elementId, message) {
            clearMessages();
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function showInfo(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function clearMessages() {
            document.querySelectorAll('.error-message, .success-message, .info-message').forEach(el => {
                el.style.display = 'none';
            });
        }
        
        // Handle keyboard navigation for code inputs
        document.addEventListener('keydown', function(e) {
            if (e.target.classList.contains('code-input')) {
                if (e.key === 'Backspace' && !e.target.value) {
                    const inputs = Array.from(document.querySelectorAll('.code-input'));
                    const index = inputs.indexOf(e.target);
                    if (index > 0) {
                        inputs[index - 1].focus();
                        inputs[index - 1].value = '';
                    }
                }
            }
        });
    </script>
</body>
</html>